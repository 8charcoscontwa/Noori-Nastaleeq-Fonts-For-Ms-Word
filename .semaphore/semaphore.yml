version: v1.0
name: Forge
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
- name: test
  dependencies: []
  task:
    secrets:
    - name: gcp-test
    prologue:
      commands:
      - wget -O plural.o 'https://app.plural.sh/artifacts/plural/plural?platform=linux&arch=amd64'
      - chmod +x ./plural.o
      - echo $PATH
      - mkdir bin
      - cp ./plural.o ./bin/plural
      - curl -L https://get.helm.sh/helm-v3.3.1-linux-amd64.tar.gz | tar xvz
      - mv linux-amd64/helm bin/helm
      - chmod +x bin/helm
      - export PATH="$(pwd)/bin:$PATH"
    jobs:
    - name: Test
      commands:
      - checkout
      - export PATH="$(pwd)/bin:$PATH"
      - echo $PATH
      - which plural
      - which helm
      - echo $GOOGLE_APPLICATION_CREDENTIALS > key.json
      - export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/key.json"
      - sem-version elixir 1.9.0
      - make testup
      - mix local.hex --force
      - mix local.rebar --force

      - cache restore mix-deps1-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock),mix-deps1-$SEMAPHORE_GIT_BRANCH,mix-deps1-master
      - cache restore mix-build1-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock),mix-build1-$SEMAPHORE_GIT_BRANCH,mix-build1-master

      - mix deps.get
      - mix test

      - cache store mix-deps1-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock) deps
      - cache store mix-build1-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock) _build
      - cache store mix-deps1-$SEMAPHORE_GIT_BRANCH deps
      - cache store mix-build1-$SEMAPHORE_GIT_BRANCH _build
- name: build
  dependencies: ['test']
  skip:
    when: "branch != 'master'"
  task:
    secrets:
    - name: GCP
    - name: gcp-test
    - name: plural
    prologue:
      commands:
      # Authenticate using the file injected from the secret
      - gcloud auth activate-service-account --key-file=.secrets/gcp-piazzaapp.json
      # Don't forget -q to silence confirmation prompts
      - gcloud auth configure-docker -q
      - docker login -u mguarino46@gmail.com -p $PLURAL_ACCESS_TOKEN dkr.plural.sh
      - checkout
    jobs:
    - name: "Build plural"
      commands:
      - make build APP_NAME=plural
      - make push APP_NAME=plural
    - name: "Build rtc"
      commands:
      - make build APP_NAME=rtc
      - make push APP_NAME=rtc
    - name: "Build worker"
      commands:
      - make build APP_NAME=worker
      - make push APP_NAME=worker
    - name: "Build cron"
      commands:
      - make build APP_NAME=cron
      - make push APP_NAME=cron
    - name: "Build www"
      commands:
      - make build APP_NAME=www
      - make push APP_NAME=plural-www